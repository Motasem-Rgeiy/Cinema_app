{% extends 'base.html' %}
{% load static %}
{% load my_filters %}

{% block title %}Select Seats - Interstellar{% endblock %}

{% block content %}
<div class="container" style="margin-top: 50px;">
    <h2 style="text-align: center;">Select Your Seats</h2>
    
    <div class="seats-container">
        <div class="screen"></div>
        
        <!-- Rows of seats -->

        {% for row in rows %}
        <div class="row">
                {% for column in columns %}
                <div class="seat {% is_exist reserved_seats row column%}"  data-seat="{{row|name}}{{column}}" ></div>
                        
                
                    

                
                {% endfor %}
            </div>
        
        {% endfor %}
<!--  
         <div class="row">
            <div class="seat" data-seat="A1"></div>
            <div class="seat" data-seat="A2"></div>
            <div class="seat occupied"></div>
            <div class="seat" data-seat="A4"></div>
            <div class="seat" data-seat="A5"></div>
            <div class="seat" data-seat="A6"></div>
            <div class="seat" data-seat="A7"></div>
            <div class="seat" data-seat="A8"></div>
        </div>
  -->
    </div>

    <div style="background-color: var(--secondary-bg); padding: 20px; border-radius: var(--border-radius); text-align: center;">
        <p>Selected Seats: <span id="selected-seats-list">None</span></p>
        <p>Total Tickets: <span id="total-tickets">0</span></p>
        <p>Total Amount: <span id="total-amount">$0</span></p>
        
        <div style="margin-top: 20px;">
            <a onclick='send_seats()' href="#" class="btn btn-primary" id="add-to-cart-btn" style="width: 200px;">Add to Cart</a>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    const seats = document.querySelectorAll('.seat:not(.occupied)');
    const totalTickets = document.getElementById('total-tickets');
    const totalAmount = document.getElementById('total-amount');
    const selectedSeatsList = document.getElementById('selected-seats-list');
    const ticketPrice = 150; // Demo price

   const MAX_SEATS = 2;

        seats.forEach(seat => {
            seat.addEventListener('click', () => {
                const selectedSeats = document.querySelectorAll('.selected');
                
                // Check if the seat is already selected (we want to allow deselecting)
                const isAlreadySelected = seat.classList.contains('selected');

                if (!isAlreadySelected && selectedSeats.length >= MAX_SEATS) {
                    // ACTION: What happens when they hit the limit
                    alert("You can only select up to 2 seats!"); 
                    // You could also trigger a modal or a shake animation here
                } else {
                    // Proceed with selection/deselection
                    seat.classList.toggle('selected');
                    updateSelection();
                }
            });
        });

    function updateSelection() {
        const selectedSeats = document.querySelectorAll('.seat.selected');
        const count = selectedSeats.length;
        const seatNames = Array.from(selectedSeats).map(s => s.getAttribute('data-seat'));
        
        totalTickets.innerText = count;
        totalAmount.innerText = '$' + (count * ticketPrice);
        selectedSeatsList.innerText = seatNames.length > 0 ? seatNames.join(', ') : 'None';
    }


async function send_seats() {
    const selectedSeats = document.querySelectorAll('.seat.selected');
    const seatNames = Array.from(selectedSeats).map(seat => seat.getAttribute('data-seat'));
    
    try {
        // 1. Send the data and await the response from Django
        const response = await axios.post('http://127.0.0.1:8000/cart/add', seatNames);
        
        // 2. Extract the message from the JsonResponse
        // Axios automatically parses JSON, storing it inside the 'data' property
        const serverMessage = response.data.message;
        
        // 3. Display the notification
        showNotification(serverMessage);

        if (response.data.redirect_url) {
            setTimeout(() => {
                window.location.href = response.data.redirect_url; //Redirect the user to the main page after it selects a seat and click "Add to cart"
            }, 2000); 
        }

    } catch (error) {
        console.error("Error sending seats:", error);
        showNotification("Failed to add tickets. Please try again.", true);
    }
}

// Helper function to handle the UI popup
function showNotification(message, isError = false) {
    // Create the notification element
    const notification = document.createElement('div');
    notification.textContent = message;
    
    // Apply styling to make it look like a floating toast notification
    Object.assign(notification.style, {
        position: 'fixed',
        bottom: '20px',
        right: '20px',
        backgroundColor: isError ? '#f44336' : '#4CAF50', // Red for errors, green for success
        color: 'white',
        padding: '16px 24px',
        borderRadius: '8px',
        boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
        zIndex: '1000',
        fontFamily: 'sans-serif',
        opacity: '1',
        transition: 'opacity 0.4s ease'
    });

    // Append it to the page
    document.body.appendChild(notification);

    // Remove the notification after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0'; // Fade out
        setTimeout(() => notification.remove(), 400); // Remove from DOM after fade completes
    }, 3000);
}






    /*
    async function send_seats(){
        const selectedSeats = document.querySelectorAll('.seat.selected');
        const seatNames = Array.from(selectedSeats).map(seat => seat.getAttribute('data-seat'));
        await axios.post('http://127.0.0.1:8000/cart/add' , seatNames);
        await axios.get('http://127.0.0.1:8000/cart/add');
       // button.href = '{% url "cart_add" %}';

    }
*/
 

</script>
{% endblock %}
{% endblock %}
